<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Map with Sidebar</title>
  <style>
    /* ì „ì²´ í™”ë©´ í¬ê¸°ì— ë§ê²Œ ë ˆì´ì•„ì›ƒ ì„¤ì • */
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      display: flex;
      font-family: Arial, sans-serif;
    }
    /* ë§µ ì œëª© ìŠ¤íƒ€ì¼ */
    .map-title {
        position: absolute; /* ë¶€ëª¨ ìš”ì†Œ ê¸°ì¤€ìœ¼ë¡œ ìœ„ì¹˜ */
        top: 10%; /* ë§µ ìƒë‹¨ì— ìœ„ì¹˜í•˜ë„ë¡ ì„¤ì • */
        left: 37%; /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
        transform: translateX(-50%); /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ ë³€í™˜ */
        font-size: 6vw; /* í™”ë©´ í¬ê¸°ì— ë¹„ë¡€í•œ ê¸€ì í¬ê¸° */
        font-weight: bold;
        color: #3b1520; /* ê¸€ì ìƒ‰ìƒ */
        z-index: 10; /* SVG ìœ„ì— í‘œì‹œë˜ë„ë¡ */
    }
    .map-container {
        width: 70vw; /* í™”ë©´ ë„ˆë¹„ì˜ 70% */
        height: 100vh; /* í™”ë©´ ë†’ì´ì˜ 100% */
        background-color: #fdefd5;
        display: flex; /* ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ Flexbox ì‚¬ìš© */
        justify-content: center; /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
        align-items: center; /* ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ */
        box-sizing: border-box;
        border: 0.5vw solid #f5ab6c;
    }
    .rectangle {
        position: absolute; /* ë§µ ë‚´ì—ì„œ ììœ ë¡­ê²Œ ë°°ì¹˜ ê°€ëŠ¥ */
        top: 32%; /* ë§µ ì¤‘ì•™ì— ìœ„ì¹˜í•˜ë„ë¡ ì„¤ì • */
        left: 3%; /* ë§µ ì¤‘ì•™ì— ìœ„ì¹˜í•˜ë„ë¡ ì„¤ì • */
        
        width: 63.9vw; /* ë„¤ëª¨ì˜ ë„ˆë¹„ */
        height: 26.2vw; /* ë„¤ëª¨ì˜ ë†’ì´ */
        background-color: transparent; /* í…Œë‘ë¦¬ë§Œ ë³´ì´ë„ë¡ ë°°ê²½ íˆ¬ëª… */
        border: 0.2vw solid #3b1520; /* ë„¤ëª¨ í…Œë‘ë¦¬ ìƒ‰ìƒê³¼ ë‘ê»˜ */
        z-index: 1; /* ë§µ ì œëª© ì•„ë˜ì— ìœ„ì¹˜ */
        pointer-events: none; /* í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì°¨ë‹¨ */
    }

    /* ì‚¬ì´ë“œë°” ì˜ì—­ (ì˜¤ë¥¸ìª½ 30%) */
    .sidebar {
      width: 30vw; /* í™”ë©´ ë„ˆë¹„ì˜ 30% */
      height: 100vh; /* í™”ë©´ ë†’ì´ì˜ 100% */
      background-color: #fdefd5;
      padding: 2vw; /* ì‚¬ì´ë“œë°” ì—¬ë°±ì„ í™”ë©´ í¬ê¸°ì— ë¹„ë¡€í•˜ê²Œ ì„¤ì • */
      box-sizing: border-box;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      border: 0.5vw solid #f5ab6c;
    }
    /* SVG ë§µ í¬ê¸° ì¡°ì • */
    .svg {
        width: 100%; /* ì»¨í…Œì´ë„ˆì˜ ë„ˆë¹„ì— ë§ì¶¤ */
        height: 100%; /* ì»¨í…Œì´ë„ˆì˜ ë†’ì´ì— ë§ì¶¤ */
        max-width: 100%; /* í™”ë©´ í¬ê¸°ì— ë”°ë¼ í¬ê¸° ì¡°ì • */
        max-height: 100%; /* í™”ë©´ í¬ê¸°ì— ë”°ë¼ í¬ê¸° ì¡°ì • */
        display: block; /* ë¶ˆí•„ìš”í•œ ì—¬ë°± ì œê±° */
        
    }
    h3,p {
      font-size: 4vw; /* ì œëª© ê¸€ì í¬ê¸° í™”ë©´ ë¹„ë¡€ */
      margin-bottom: 2vw; /* ì•„ë˜ìª½ ì—¬ë°± ë™ì¼ ì ìš© */
      margin-top: 2vw; /* ìœ„ìª½ ì—¬ë°± ì œê±° */
      color: #3b1520;
    }
    
    /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
    input[type="text"] {
    width: 80%; /* í•„ë“œ ë„ˆë¹„ë¥¼ ë¶€ëª¨ ìš”ì†Œì˜ 80% */
    padding: 1.5vh 1.5vw; /* íŒ¨ë”©ì„ í™”ë©´ ë¹„ë¡€ */
    font-size: 1.5vw; /* ê¸€ì í¬ê¸° í™”ë©´ ë¹„ë¡€ */
    border: 0.3vw solid #f5ab6c; /* í…Œë‘ë¦¬ ë‘ê»˜ í™”ë©´ ë¹„ë¡€ */
    border-radius: 0.5vw; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ í™”ë©´ ë¹„ë¡€ */
    box-sizing: border-box;
    margin-bottom: 2vw; /* ì•„ë˜ìª½ ì—¬ë°± ë™ì¼ ì ìš© */
    margin-top: 2vw; /* ìœ„ìª½ ì—¬ë°± ì œê±° */
    }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    button {
    padding: 1.5vh 2vw; /* ë²„íŠ¼ íŒ¨ë”© í™”ë©´ ë¹„ë¡€ */
    font-size: 2vw; /* ê¸€ì í¬ê¸° í™”ë©´ ë¹„ë¡€ */
    border: 0.3vw solid #f5ab6c; /* í…Œë‘ë¦¬ ë‘ê»˜ í™”ë©´ ë¹„ë¡€ */
    border-radius: 0.5vw; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
    background-color: #f5ab6c;
    color: #fff;
    cursor: pointer;
    margin-bottom: 2vw; /* ì•„ë˜ìª½ ì—¬ë°± ë™ì¼ ì ìš© */
    margin-top: 2vw; /* ìœ„ìª½ ì—¬ë°± ì œê±° */
    }

    /* ë¼ë²¨ ìŠ¤íƒ€ì¼ */
    label {
    font-size: 2vw; /* ë¼ë²¨ ê¸€ì í¬ê¸° í™”ë©´ ë¹„ë¡€ */
    display: block; /* ë¼ë²¨ì„ ë¸”ë¡ ìš”ì†Œë¡œ */
    margin-bottom: 1vh; /* í•„ë“œì™€ì˜ ê°„ê²© */
    margin-bottom: 2vw; /* ì•„ë˜ìª½ ì—¬ë°± ë™ì¼ ì ìš© */
    margin-top: 2vw; /* ìœ„ìª½ ì—¬ë°± ì œê±° */
    color: #3b1520;
    }

    /* íŒì—… ìŠ¤íƒ€ì¼ */
    #popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    #popup-content {
        background: #ffffff;
        padding: 3vw; /* ìƒëŒ€ ë‹¨ìœ„ë¡œ ë³€ê²½ */
        border-radius: 1.5vw; /* ë°˜ì‘í˜• ëª¨ì„œë¦¬ */
        text-align: center;
        border: 0.3vw solid #f5ab6c;
        box-shadow: 0 0.4vw 0.6vw rgba(0, 0, 0, 0.1); /* ë°˜ì‘í˜• ê·¸ë¦¼ì */
        width: 40vw; /* ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
    }
    #popup-content p {
        font-size: 1.5vw; /* ê¸€ì í¬ê¸° (vw ì‚¬ìš©) */
        font-family: 'Apple SD Gothic Neo', sans-serif;
        color: #3b1520;
        line-height: 3vw; /* ì¤„ ê°„ê²© */
        margin: 1vw 0; /* ë¬¸ë‹¨ ê°„ê²© */
        font-weight: 540; /* êµµê²Œ ì„¤ì • */
    }
    #cancel {
        margin-top: 2vw;
        padding: 0.5vw 1vw; /* ë²„íŠ¼ í¬ê¸° ì¡°ì • */
        background: #f5ab6c;
        color: white;
        border: none;
        border-radius: 1vw;
        cursor: pointer;
        font-size: 1.2vw; /* ë²„íŠ¼ í…ìŠ¤íŠ¸ í¬ê¸° */
    }
    #cancel:hover {
        background: #d88c4c; /* í˜¸ë²„ ì‹œ ìƒ‰ìƒ */
    }

  </style>
</head>

<body>
<div class="map-container">
    <div class="map-title">Map</div>
    
    <svg class="svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 200" preserveAspectRatio="xMidYMid meet">
        <rect
        style="display:inline;fill:#fdefd5;fill-opacity:1;stroke:#3b1520;stroke-width:1"
        width="279.5"
        height="115.7"
        x="10.25"
        y="58.95"
        />

        <g id="bookstore_group" inkscape:label="bookstore">
            <path
                id="bookstore_path"
                style="fill:#f5ab6c;fill-opacity:1;stroke-width:0.346803"
                d="M 189.17157,59.603269 228.6818,91.4082 h 60.55172 V 59.603269 Z"
            />
            <text
                style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:5.75805px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;text-align:start;writing-mode:lr-tb;direction:ltr;text-anchor:start;fill:#3d1422;fill-opacity:1;stroke-width:0.0340049"
                x="252.73248"
                y="77.569412"
            >
                <tspan
                    style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:5.75805px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;fill:#3d1422;fill-opacity:1;stroke-width:0.0340049"
                    x="252.73248"
                    y="77.569412">ì„œì 
                </tspan>
            </text>
            <text
                style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:12.8023px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;text-align:start;writing-mode:lr-tb;direction:ltr;text-anchor:start;fill:#3d1422;fill-opacity:1;stroke-width:0.264583"
                x="235.15654"
                y="78.611107"
            >
                <tspan
                style="stroke-width:0.264583"
                x="235.15654"
                y="78.611107">ğŸ“š
                </tspan>
            </text>
        </g>
        
        <g id="foodcourt_group" inkscape:label="foodcourt">
            <path
                id="foodcourt_path"
                style="fill:#f5ab6c;fill-opacity:1;stroke-width:0.310848"
                d="m 251.5411,116.60437 -9.80856,9.48227 v 47.93164 h 47.50098 v -57.41391 z"
            />
            <text
            style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:5.75805px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;text-align:start;writing-mode:lr-tb;direction:ltr;text-anchor:start;fill:#3d1422;fill-opacity:1;stroke-width:0.0340049"
            x="256.36157"
            y="157.12558"
            >
                <tspan
                style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:5.75805px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;fill:#3d1422;fill-opacity:1;stroke-width:0.0340049"
                x="256.36157"
                y="157.12558">í‘¸ë“œì½”íŠ¸
                </tspan>
            </text>
                
            <text
                style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:12.8023px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;text-align:start;writing-mode:lr-tb;direction:ltr;text-anchor:start;fill:#3d1422;fill-opacity:1;stroke-width:0.264583"
                x="259.08548"
                y="146.18373"
            >
                <tspan
                style="stroke-width:0.264583"
                x="259.08548"
                y="146.18373">ğŸœ
                </tspan>
            </text>
        </g>
    
        <g id="cinema_group" inkscape:label="cinema">
            <path
                id="cinema_path"
                style="fill:#f5ab6c;fill-opacity:1;stroke-width:0.32783"
                d="m 59.370233,59.603269 v 36.760882 h 72.716237 l 7.20923,-7.922082 v -28.8388 z"
            />
            
            <text
                style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:5.75805px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;text-align:start;writing-mode:lr-tb;direction:ltr;text-anchor:start;fill:#3d1422;fill-opacity:1;stroke-width:0.0340049"
                x="90.574997"
                y="86.363655"
            >
                <tspan
                    style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:5.75805px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;fill:#3d1422;fill-opacity:1;stroke-width:0.0340049"
                    x="90.574997"
                    y="86.363655">ì˜í™”ê´€
                </tspan>
            </text>
            
            <text
                style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:12.8023px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;text-align:start;writing-mode:lr-tb;direction:ltr;text-anchor:start;fill:#3d1422;fill-opacity:1;stroke-width:0.264583"
                x="90.318848"
                y="76.260033"
            >
                <tspan
                    style="stroke-width:0.264583"
                    x="90.318848"
                    y="76.260033">ğŸ¥
                </tspan>
            </text>
        </g>
        
    
        <g id="restroom_group" inkscape:label="restroom">
            <path
                id="restroom_path"
                style="fill:#f5ab6c;fill-opacity:1;stroke-width:0.289622"
                d="m 117.78023,146.65398 -5.2295,3.94971 v 23.41459 h 42.64713 v -23.52932 l -5.49043,-3.83498 z"
            />
            <text
                style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:5.75805px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;text-align:start;writing-mode:lr-tb;direction:ltr;text-anchor:start;fill:#3d1422;fill-opacity:1;stroke-width:0.0340049"
                x="125.31876"
                y="170.83263"
            >
                <tspan
                style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:5.75805px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;fill:#3d1422;fill-opacity:1;stroke-width:0.0340049"
                x="125.31876"
                y="170.83263">í™”ì¥ì‹¤
                </tspan>
            </text>
            <text
                style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:12.8023px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;text-align:start;writing-mode:lr-tb;direction:ltr;text-anchor:start;fill:#3d1422;fill-opacity:1;stroke-width:0.264583"
                x="125.08523"
                y="161.53838"
            >
                <tspan
                style="stroke-width:0.264583"
                x="125.08523"
                y="161.53838">ğŸš»
                </tspan>
            </text>
        </g>
        
        <g id="convenience_group" inkscape:label="convenience">
            <rect
                id="convenience_path"
                style="fill:#f5ab6c;fill-opacity:1;stroke-width:0.279863"
                width="62.179001"
                height="35.109276"
                x="10.836945"
                y="138.90901"
            />
            <text
                style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:5.75805px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;text-align:start;writing-mode:lr-tb;direction:ltr;text-anchor:start;fill:#3d1422;fill-opacity:1;stroke-width:0.0340049"
                x="32.34037"
                y="165.59154"
            >
                <tspan
                style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:5.75805px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;fill:#3d1422;fill-opacity:1;stroke-width:0.0340049"
                x="32.34037"
                y="165.59154">í¸ì˜ì 
                </tspan>
            </text>
            <text
                style="font-style:normal;font-variant:normal;font-weight:normal;font-stretch:normal;font-size:12.8023px;font-family:HYGothic-Extra;-inkscape-font-specification:'HYGothic-Extra, Normal';font-variant-ligatures:normal;font-variant-caps:normal;font-variant-numeric:normal;font-variant-east-asian:normal;text-align:start;writing-mode:lr-tb;direction:ltr;text-anchor:start;fill:#3d1422;fill-opacity:1;stroke-width:0.264583"
                x="32.059776"
                y="155.92024"
            >
                <tspan
                style="stroke-width:0.264583"
                x="32.059776"
                y="155.92024">ğŸ›’
                </tspan>
            </text>
        </g> 
        
    </svg>
</div>

<div class="sidebar">
    <div class="sidebar-content">
        <h3>ê¸¸ ì•ˆë‚´</h3>
        <label for="start-location">ì¶œë°œ ìœ„ì¹˜:</label>
        <input type="text" id="start-location" placeholder="ì¶œë°œ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”" readonly>
        
        <label for="end-location">ë„ì°© ìœ„ì¹˜:</label>
        <input type="text" id="end-location" placeholder="ë„ì°© ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ì„¸ìš”" readonly>

        <button id="show-route">AGV í˜¸ì¶œ</button>
    </div>
</div>

<div id="popup" style="display: none;">
    <div id="popup-content">
        <p id="popup-text"></p>
        <button id="cancel" onclick="cancelAction()">í˜¸ì¶œ ì·¨ì†Œ</button>
    </div>
</div>

<script>
    let selectedBox = null; // í˜„ì¬ ì„ íƒëœ ì…ë ¥ ë°•ìŠ¤
    let startLocation = null;
    let endLocation = null;
    var call_in_progress = localStorage.getItem('call_in_progress') === 'true'; // í˜¸ì¶œ ì§„í–‰ ìƒíƒœ

    //esp32 ë‘ í†µì‹ 
    function sendLocationToESP32(area) 
    {
        const esp32Ip = "http://172.30.1.31:80"; // ESP32ì˜ IP ì£¼ì†Œ
        fetch(`${esp32Ip}/location?area=${encodeURIComponent(area)}`, { method: 'GET' })
            .then(response => response.text())
            .then
                (data => 
                    {
                        console.log("Response from ESP32: " + data);
                        // alert("ESP32ë¡œë¶€í„° ì‘ë‹µ: " + data);
                    }
                )
            .catch
                (error => 
                    {
                        console.error("Error communicating with ESP32:", error);
                        // alert("ESP32ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."+ error);
                    }
                );
    }

    window.onload = function() {
        sendLocationToESP32("Navigation");
    }

    // ê° ì¥ì†Œì˜ ì¢Œí‘œ ë° ì´ë¦„ ì •ì˜
    const locations = {
        bookstore_group: { name: 'ì„œì ', en_name: 'Bookstore' },
        foodcourt_group: { name: 'í‘¸ë“œì½”íŠ¸', en_name: 'Foodcourt' },
        cinema_group: { name: 'ì˜í™”ê´€', en_name: 'Cinema' },
        restroom_group: { name: 'í™”ì¥ì‹¤', en_name: 'Restroom' },
        convenience_group: { name: 'í¸ì˜ì ', en_name: 'Convenience Store' },
    };

    // ì¶œë°œ ìœ„ì¹˜ì™€ ë„ì°© ìœ„ì¹˜ ì…ë ¥ ë°•ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸
    document.getElementById('start-location').addEventListener('click', function() {
        selectedBox = 'start-location';
    });

    document.getElementById('end-location').addEventListener('click', function() {
        selectedBox = 'end-location';
    });

    // ê° ì¥ì†Œ Path, Rect ë° Groupì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    document.querySelectorAll('path, rect, g').forEach(element => {
        element.addEventListener('click', function() {
            const locationId = this.id; // í´ë¦­í•œ ìš”ì†Œì˜ ID ê°€ì ¸ì˜¤ê¸°
            setLocation(locationId);
        });
    });

    // í´ë¦­ëœ ì¥ì†Œë¥¼ ì„ íƒëœ ì…ë ¥ ë°•ìŠ¤ì— ì„¤ì •
    function setLocation(locationId) {
        if (!locations[locationId]) return;

        if (selectedBox === 'start-location') {
            startLocation = locations[locationId];
            document.getElementById('start-location').value = startLocation.name;
        } else if (selectedBox === 'end-location') {
            endLocation = locations[locationId];
            document.getElementById('end-location').value = endLocation.name;
        }
    }



    const popup = document.getElementById('popup');
    const popupText = document.getElementById('popup-text');
    const closePopup = document.getElementById('cancel');



    // ì ì„ ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
    let dotCount = 0;
    let dotInterval;
    function createDots() {
        dotCount = 0; // ì²˜ìŒ ì‹œì‘í•  ë•Œ ì ì„ 0ìœ¼ë¡œ ì´ˆê¸°í™”

        // ì ì„ ì¶”ê°€í•˜ëŠ” interval ì„¤ì •
        dotInterval = setInterval(() => {
            if (dotCount < 3) {
                dotCount++; // ì  í•˜ë‚˜ì”© ì¶”ê°€
            } else {
                dotCount = 1; // ì ì´ 3ê°œê°€ ë˜ë©´ ë‹¤ì‹œ 1ê°œë¡œ
            }
            updatePopupText(); // ì ì„ ì—…ë°ì´íŠ¸
        }, 500); // 0.5ì´ˆë§ˆë‹¤ ì ì„ ê°±ì‹ 

        return '.'.repeat(dotCount); // í˜„ì¬ ì ì˜ ê°¯ìˆ˜ì— ë§ëŠ” ì ì„ ë°˜í™˜
    }

    // íŒì—… í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updatePopupText() {
        popupText.innerHTML = `
            ì¶œë°œ: ${startLocation.name}, ë„ì°©: ${endLocation.name}<br><br>
            agvê°€ ì˜¤ê³  ìˆìŠµë‹ˆë‹¤${'.'.repeat(dotCount)}<br>
            ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
        `;
    }
    // íŒì—…ì„ ë„ìš°ê³  3ì´ˆ í›„ì— ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function showPopupAndRedirect() {
        const popup = document.getElementById('popup');
        popup.style.display = 'flex';  // íŒì—… ë³´ì´ê¸° (flexë¡œ ìˆ˜ì •í•˜ì—¬ ì¤‘ì•™ ì •ë ¬ ìœ ì§€)
        call_in_progress = false; // í˜¸ì¶œ ìƒíƒœë¥¼ falseë¡œ ì„¤ì •
        localStorage.setItem('call_in_progress', call_in_progress); // ìƒíƒœë¥¼ localStorageì— ì €ì¥
        // 3ì´ˆ í›„ì— íŒì—…ì„ ìˆ¨ê¸°ê³  ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        setTimeout(function() {
            popup.style.display = 'none';  // íŒì—… ìˆ¨ê¸°ê¸°
            window.location.href = '/';  // ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        }, 3000); // 3ì´ˆ í›„
    }


</script>

<script>
const ws = new WebSocket("ws://172.30.1.31:83"); // ESP32ì˜ IP ì£¼ì†Œ

ws.onopen = () => {
    console.log('WebSocket ì—°ê²° ì„±ê³µ');
};

ws.onmessage = (event) => {
    if (event.data === "start") {
        clearInterval(dotInterval);  // ì  ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
        popupText.innerHTML = `
            AGVê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤.<br><br>
            ì†ì¡ì´ë¥¼ ì¡ê³  ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
        `;
        document.getElementById('cancel').style.display = 'none';  // í˜¸ì¶œ ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    }
    else if(event.data === "go") {
        clearInterval(dotInterval);  // ì  ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
        popupText.innerHTML = `
            ì•ˆë‚´ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.<br><br>
            ì €ë¥¼ ë”°ë¼ì˜¤ì„¸ìš”!
        `;
        document.getElementById('cancel').style.display = 'none';  // í˜¸ì¶œ ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
    }
    else if(event.data === "arrive") {
        clearInterval(dotInterval);  // ì  ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
        popupText.innerHTML = `
            AGVê°€ ëª©ì ì§€ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤.<br><br>
            ê°ì‚¬í•©ë‹ˆë‹¤!
        `;
        document.getElementById('cancel').style.display = 'none';  // í˜¸ì¶œ ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        showPopupAndRedirect();  // íŒì—…ì„ ë„ìš°ê³  3ì´ˆ í›„ì— ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    }
};

ws.onerror = (error) => {
    console.error("WebSocket ì—ëŸ¬:", error);
};

// í˜¸ì¶œ ì·¨ì†Œ ë²„íŠ¼
function cancelAction() {
    // íŒì—…ì„ ë‹«ê¸°
    var popup = document.getElementById('popup');
    popup.style.display = 'none';
    clearInterval(dotInterval); // íŒì—… ë‹«ì„ ë•Œ ì  ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€

    // WebSocketìœ¼ë¡œ 'cancel' ë©”ì‹œì§€ ì „ì†¡
    if (ws.readyState === WebSocket.OPEN) {
        ws.send("cancel"); // WebSocketìœ¼ë¡œ 'cancel' ë©”ì‹œì§€ ì „ì†¡
        console.log("WebSocketìœ¼ë¡œ cancel ë©”ì‹œì§€ ì „ì†¡!");
    } else {
        console.log("WebSocket ì—°ê²°ì´ ë‹«í˜€ ìˆìŠµë‹ˆë‹¤.");
    }
    // ì¼ì • ì‹œê°„ í›„ì— í˜ì´ì§€ë¥¼ ë¦¬ë‹¤ì´ë ‰íŠ¸
    setTimeout(function() {
        window.location.href = '/';  // í˜¸ì¶œ ì·¨ì†Œ í›„ í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰íŠ¸
    }, 500); // 500ms (0.5ì´ˆ) ê¸°ë‹¤ë¦° í›„ í˜ì´ì§€ ë¦¬ë‹¤ì´ë ‰íŠ¸
}
//---------------------------------------------------------------------------------------------//

document.getElementById('show-route').addEventListener('click', function () {
    if (startLocation && endLocation) {
        // íŒì—… í‘œì‹œ
        popupText.innerHTML = `
            ì¶œë°œ: ${startLocation.name}, ë„ì°©: ${endLocation.name}<br><br>
            agvê°€ ì˜¤ê³  ìˆìŠµë‹ˆë‹¤${createDots()}<br>
            ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!
        `;
        popup.style.display = 'flex';

        // ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ í…ìŠ¤íŠ¸ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        const data = `${startLocation.en_name},${endLocation.en_name}`;
        call_in_progress = true; // í˜¸ì¶œ ìƒíƒœë¥¼ trueë¡œ ì„¤ì •
        localStorage.setItem('call_in_progress', call_in_progress); // ìƒíƒœë¥¼ localStorageì— ì €ì¥
        sendLocationToESP32(data);
    } else {
        alert('ì¶œë°œì§€ì™€ ë„ì°©ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
    }
});



</script>

</body>
</html>
